/*! Volksoper - v0.1.0 - 2012-12-30
* http://PROJECT_WEBSITE/
* Copyright (c) 2012 tshinsay; Licensed MIT */
var volksoper;(function(e){var t=function(){function e(e){this._type=e,this._propagates=!0,this._stopImmediate=!1,this._callDefault=!0}return e.ADDED="added",e.REMOVE="remove",e.ADDED_TO_SCENE="addedToScene",e.REMOVE_FROM_SCENE="removeFromScene",e.ADDED_TO_STAGE="addedToStage",e.REMOVE_FROM_STAGE="removeFromScene",Object.defineProperty(e.prototype,"type",{get:function(){return this._type},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"propagates",{get:function(){return this._propagates},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"stopImmediate",{get:function(){return this._stopImmediate},enumerable:!0,configurable:!0}),e.prototype.stopPropagation=function(){this._propagates=!1},e.prototype.stopPropagationImmediate=function(){this._propagates=!1,this._stopImmediate=!0},e.prototype.preventDefault=function(){this._callDefault=!1},e}();e.Event=t})(volksoper||(volksoper={}));var volksoper;(function(e){e.SYSTEM_PRIORITY=1e8;var t=function(){function t(){}return t._handlerNameTable={},t.prototype.addChild=function(t){this._children=this._children||[],t._parent=this,this._children.push(t),t.propagateEvent(new e.Event(e.Event.ADDED))},t.prototype.removeChild=function(t){if(!this._children)return!1;var n=this._children.indexOf(t);return n>=0?(t.propagateEvent(new e.Event(e.Event.REMOVE)),this._children.splice(n,1),t._parent=null,!0):!1},t.prototype.popChild=function(){var t=this.topChild;return t?(t.propagateEvent(new e.Event(e.Event.REMOVE)),this._children.pop(),t._parent=null,t):null},t.prototype.swapTop=function(e){var t=this.popChild();return t&&this.addChild(e),t},Object.defineProperty(t.prototype,"topChild",{get:function(){return!this._children||this._children.length==0?null:this._children[this._children.length-1]},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"numChildren",{get:function(){return this._children?this._children.length:0},enumerable:!0,configurable:!0}),t.prototype.sortChildren=function(e){this._children=this._children||[],this._children.sort(e)},t.prototype.getChild=function(e){return this._children==null?null:this._children[e]},t.prototype.addEventListener=function(e,n,r,i){r?this._captureHandlers=t._registerListener(this._captureHandlers,e,n,i):this._bubbleHandlers=t._registerListener(this._bubbleHandlers,e,n,i)},t.prototype.removeEventListener=function(e,n,r){return r?t._removeHandler(this._captureHandlers,e,n):t._removeHandler(this._bubbleHandlers,e,n)},t._removeHandler=function(t,n,r){if(!t)return!1;var i=t[n];for(var s in i){var o=i[s].handler;if(o===r)return i.splice(s,1),!0}return!1},t._registerListener=function(t,n,r,i){return i=i||0,t=t||{},n in t||(t[n]=[]),t[n].push({priority:i,handler:r}),t[n].sort(function(e,t){return t.priority-e.priority}),t},t.prototype.dispatchEvent=function(e){return this._handleEvent(e,this,!1)},t.prototype.propagateEvent=function(e){var t=!1,n=[this],r=this,i=0;while(r=r._parent)n.push(r);var s=n.length;for(i=s-1;i>=0;i--){t=n[i]._handleEvent(e,this,!0)||t;if(!e.propagates)return t}for(i=0;i<s;i++){t=n[i]._handleEvent(e,this,!1)||t;if(!e.propagates)return t}return t},t.prototype.broadcastEvent=function(e,t){return this._broadcastEvent(e,t?t:this)},t.prototype._broadcastEvent=function(e,t){var n=!1;n=this._handleEvent(e,t,!1)||n;if(this._children)for(var r=0;r<this._children.length;++r)n=this._children[r]._broadcastEvent(e,t)||n;return n},t.prototype._handleEvent=function(t,n,r){t.currentTarget=this,t.target=n;if(!r&&this._callHandler(t)&&t.stopImmediate)return!0;var i=t.type,s;r&&this._captureHandlers?s=this._captureHandlers[i]:!r&&this._bubbleHandlers&&(s=this._bubbleHandlers[i]);if(!s||s.length==0)return!1;for(var o in s){var u=s[o].handler;if(s[o].priority!==e.SYSTEM_PRIORITY||t._callDefault){t.currentTarget=this,t.target=n,u(t);if(t.stopImmediate)break}}return t._callDefault=!0,!0},t.prototype._callHandler=function(e){var n=t._handlerNameTable[e.type]||t._getHandlerName(e);return this[n]?(this[n](e),!0):!1},t._getHandlerName=function(n){var r=n.type,i="on"+r.charAt(0).toUpperCase()+r.substr(1);return t._handlerNameTable[r]=i,i},t}();e.Actor=t})(volksoper||(volksoper={}));var volksoper;(function(e){(function(e){function t(e){return e}e.LINEAR=t})(e.Easing||(e.Easing={}));var t=e.Easing})(volksoper||(volksoper={}));var volksoper;(function(e){function t(e){var t=[];return function(n,r){if(r)return t.push(r),!1;while(t.length!=0){if(t[0](n))return!0;t.shift()}return e&&e(),!1}}function n(e){return function(){e()}}function r(){var e=[];return function(t,n){if(n)return e.push(n),!1;for(var r=0;r<e.length;++r)e[r](t)||(e.splice(r,1),r-=1);return e.length!==0}}function i(e,t){var n=!1,r=function(i){t.removeEventListener(e,r),n=!0};return t.addEventListener(e,r),function(){return!n}}function s(e,t,n,r){var i={},s=0;for(var o in t)i[o]=e[o];return function(o){var u=o.consume(n-s),a=null;if(u>=0){s+=u;for(a in t){var f=r(s/n);e[a]=(1-f)*i[a]+f*t[a]}return!0}for(a in t)e[a]=t[a];return!1}}function o(e){return function(){return e(),!1}}var u=function(){function u(e,t){this._board=e,this._hero=t,this._state="normal"}return u.prototype._createScenario=function(){if(!this._scenario){this._board._registerStory(this);var e=this;this._scenario=t(function(){e._scenario=null,e._board._unregisterStory(e)})}},u.prototype._addScenario=function(e){this._createScenario();switch(this._state){case"normal":this._scenario(null,e);break;case"and":this._and(null,e),this._state="unknown";break;case"unknown":this._scenario(null,e),this._state="normal"}},u.prototype.wait=function(){var t=r();for(var s=0;s<arguments.length;++s){var o=arguments[s];typeof o=="string"?t(null,i(o,this._hero)):o instanceof e.Story?t(null,o._scenario):t(null,n(o))}return this._addScenario(t),this},u.prototype.then=function(e){return this._addScenario(o(e)),this},u.prototype.waitEvent=function(e,t){return this._addScenario(i(e,t)),this},u.prototype._createTween=function(t,n,r){var i,o,u;if(r.length==1){var a=r[0];i=a.easing||e.Easing.LINEAR,delete a.easing,u=a.time||1,delete a.time,o=a}else i=r[2]||e.Easing.LINEAR,o={},o[r[0]]=r[1];t&&(o=t(o)),this._addScenario(s(n,o,u,i))},u.prototype.tween=function(e){return this._createTween(null,this._hero,arguments),this},u.prototype.tweenBy=function(e){this._createScenario();var t=this._hero;return this._createTween(function(e){for(var n in e)e[n]=e[n]+t[n];return e},t,arguments),this},u.prototype.call=function(e){var t=[];for(var n=0;n<arguments.length-1;n++)t[n]=arguments[n+1];this._createScenario();var r=this._hero;return this._addScenario(function(){return r[e].apply(r,t),!1}),this},Object.defineProperty(u.prototype,"and",{get:function(){switch(this._state){case"normal":this._and=t(null);break;case"and":break;case"unknown":this._state="and"}return this},enumerable:!0,configurable:!0}),u.prototype._update=function(e){this._scenario(e)},u}();e.Story=u})(volksoper||(volksoper={}));var volksoper;(function(e){var t=function(){function e(){this._time=0}return e.prototype.setTime=function(e){this._time=e},e.prototype.consume=function(e){return this._time<e?(this._time=0,this._time-e):(this._time-=e,-1)},e}(),n=function(){function n(){this._stories=[],this._timer=new t,this._unregister=[]}return n.prototype.update=function(e){this._unregister.splice(0),this._timer.setTime(e);for(var t=0;t<this._stories.length;t++)this._stories[t]._update(this._timer);for(var t=0;t<this._unregister.length;++t)this._stories.splice(this._stories.indexOf(this._unregister[t]),1);return this._stories.length==0},n.prototype._registerStory=function(e){var t=this._unregister.indexOf(e);t>=0?this._unregister.splice(t,0):this._stories.push(e)},n.prototype._unregisterStory=function(e){this._unregister.push(e)},n.prototype.story=function(t){return new e.Story(this,t)},Object.defineProperty(n.prototype,"numStories",{get:function(){return this._stories.length},enumerable:!0,configurable:!0}),n}();e.StoryBoard=n})(volksoper||(volksoper={}));var __extends=this.__extends||function(e,t){function n(){this.constructor=e}n.prototype=t.prototype,e.prototype=new n},volksoper;(function(e){var t=function(t){function n(){t.call(this),this._registry={},this._execFind=0,this._unregister=[],this._board=new e.StoryBoard;var n=this,r=function(t){n._registerTarget(t.target),t.target.broadcastEvent(new e.Event(e.Event.ADDED_TO_SCENE),n)},i=function(t){t.target.broadcastEvent(new e.Event(e.Event.REMOVE_FROM_SCENE),n),n._unregisterTarget(t.target)};this.addEventListener(e.Event.ADDED,r,!0,e.SYSTEM_PRIORITY),this.addEventListener(e.Event.REMOVE,i,!0,e.SYSTEM_PRIORITY)}return __extends(n,t),Object.defineProperty(n.prototype,"storyBoard",{get:function(){return this._board},enumerable:!0,configurable:!0}),n.prototype._registerTarget=function(e){this._iterateTable(e,function(t){t.push(e)})},n.prototype._iterateTable=function(e,t){var n=e.constructor.group;if(typeof n=="string")this._callbackGroup(n,t);else if(n instanceof Array)for(var r=0;r<n.length;++r)this._callbackGroup(n[r],t)},n.prototype._callbackGroup=function(e,t){var n=this._registry[e];n||(this._registry[e]=n=[]),t(n)},n.prototype._unregisterTarget=function(e){var t=this;this._execFind===0?this._iterateTable(e,function(t){console.log(t.indexOf(e)),t.splice(t.indexOf(e),1)}):this._iterateTable(e,function(n){t._unregister=[n,e]})},n.prototype.find=function(e,t){this._execFind++,this._callbackGroup(e,function(e){var n=e.length;for(var r=0;r<n;++r)t(e[r])}),this._execFind--;var n=this._unregister,r=n.length;for(var i=0;i<r;++i)n[i][0].splice(n[i][0].indexOf(n[i][1]),1);n.splice(0)},n}(e.Actor);e.Scene=t})(volksoper||(volksoper={}));var volksoper;(function(e){var t=function(t){function n(){t.call(this),this.alpha=1,this.x=0,this.y=0,this.z=0,this.width=0,this.height=0,this.rotation=0,this.rotationX=0,this.rotationY=0,this.scaleX=1,this.scaleY=1,this.visible=!0;var n=this;this.addEventListener(e.Event.ADDED_TO_SCENE,function(e){n._scene=e.target},!1,e.SYSTEM_PRIORITY),this.addEventListener(e.Event.REMOVE_FROM_SCENE,function(e){n._scene=null}),this.addEventListener(e.Event.ADDED_TO_STAGE,function(e){n._stage=e.target},!1,e.SYSTEM_PRIORITY),this.addEventListener(e.Event.REMOVE_FROM_STAGE,function(e){n._stage=null})}return __extends(n,t),Object.defineProperty(n.prototype,"scene",{get:function(){return this._scene},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"stage",{get:function(){return this._stage},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"story",{get:function(){return this._story?this._story:(this._story=this._scene.storyBoard.story(this),this._story)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"surface",{get:function(){return this._surface},set:function(e){this._surface&&this._surface.release(),this._surface=e,e.addRef()},enumerable:!0,configurable:!0}),n}(e.Actor);e.Sprite=t})(volksoper||(volksoper={}));var volksoper;(function(e){var t=function(t){function n(){t.call(this);var n=this,r=function(t){t.target.broadcastEvent(new e.Event(e.Event.ADDED_TO_STAGE),n)},i=function(t){t.target.broadcastEvent(new e.Event(e.Event.REMOVE_FROM_STAGE),n)};this.addEventListener(e.Event.ADDED,r,!0,e.SYSTEM_PRIORITY),this.addEventListener(e.Event.REMOVE,i,!0,e.SYSTEM_PRIORITY)}return __extends(n,t),n}(e.Sprite);e.Stage=t})(volksoper||(volksoper={}));var volksoper;(function(e){var t=function(){function e(){this._referenceCount=0}return e.prototype.invalidate=function(){},e.prototype.addRef=function(){return++this._referenceCount},e.prototype.release=function(){return--this._referenceCount},e.prototype.count=function(){return this._referenceCount},e}();e.Surface=t})(volksoper||(volksoper={}));